\section{Poisson Solver}
\label{sec:Poisson}


This section reviews how Poisson's equation is solved on a double-mesh configuration. 
Many parts of the algorithm are identical to {\small PMFAST}, hence we refer the reader 
to section 2 of MPT for more details. In {\small CUBEP3M}, the mass default assignment scheme are
a `cloud-in-cell' (CIC) interpolation for the coarse grid,  and a `nearest-grid-point' (NGP) interpolation 
for the fine grid \citep{1981csup.book.....H}. This choice is motivated by the fact that the most straightforward 
way to implement a P$^3$M algorithm on a mesh is to have exactly zero mesh force inside a grid, 
which is only true for the NGP interpolation. Although CIC generally has a smoother and more accurate force,
the pp implementation enhances the code resolution by almost an order of magnitude. 
We impose a softening length of one tenth of a grid cell to prevent
large scattering; particles seperated by less than this distance have their 
particle-particle force set to zero.

The code units inherit from \citep{2004NewA....9..443T} and are summarized here for completeness.
The comoving length of a fine grid cell is set to one,
such that the unit length in simulation unit is 
\begin{eqnarray}
1\mathcal{L} = a \frac{L}{N} 
\end{eqnarray}
where $a$ is the scale factor, $N$ is the total number of cells along one dimension,
and $L$ is the comoving volume in $h^{-1}\mbox{Mpc}$.
The mean comoving mass density is also set to unity in simulation units, 
which, in physical units, corresponds to 
\begin{eqnarray}
1\mathcal{D} = \rho_{m}(0) a^{-3} = \Omega_{m} \rho_{c} a^{-3} = \frac{3 \Omega_{m} H_{o}^{2}}{8 \pi G a^{3} }
\end{eqnarray}
$\Omega_{m}$ is the matter density, $H_{o}$ is the Hubble's constant, $\rho_{c}$ is the critical density today,
and $G$ is Newton's constant. The mass unit is found with $\mathcal{M} = \mathcal{DL}^{3}$.
Specifying the value of $G$ on the grid fixes the time unit, and with $G_{grid}$ = 1/$(6 \pi a)$,
we get:
\begin{eqnarray}
1 \mathcal{T} = \frac{2a^{2}}{3}\frac{1}{\sqrt{\Omega_{m}H_{o}^{2}}}
\end{eqnarray}
These choices completely determine the convertion between physical and simulation units.
For instance, the velocity units are given by $1\mathcal{V} = \mathcal{L}$/$\mathcal{T}$.



The force of gravity on a mesh can be computed either with a gravitational potential  kernel $\omega_{\phi} ({\bf x})$
  or a force  kernel $\omega_{F} ({\bf x})$.
Gravity fields are curl-free, which allows us to relate the potential $\phi({\bf x})$ to the source term via Poisson's equation: 
\begin{eqnarray}
\nabla^{2}\phi({\bf x}) = 4 \pi G \rho({\bf x})
\label{eq:poisson}
\end{eqnarray}
We solve this equation in Fourier space, where we write:
\begin{eqnarray}
 \tilde{\phi}({\bf k}) = \frac{-4 \pi G \tilde{\rho}({\bf k})}{k^{2}} \equiv \tilde{\omega}_{\phi}({\bf k})\tilde{\rho}({\bf k})
\label{eq:poissonFourier}
\end{eqnarray}
The potential in real space is then obtained with an inverse Fourier transform, and the kernel becomes $\omega_{\phi} ({\bf x}) = -G/r$.
Using the convolution theorem, we can write
\begin{eqnarray}
 \phi({\bf x}) = \int \rho({\bf x'}) \omega_{\phi}({\bf x'} - {\bf x}) d{\bf x'}   
\label{eq:poisson_solution_pot}
\end{eqnarray}
and
\begin{eqnarray}
{\bf F}({\bf x}) = - m {\bf \nabla} \phi({\bf x}) 
\label{eq:Force_sol}
\end{eqnarray}
Although this approach is fast, it involves a finite differentiation at the final step, which enhances the numerical noise.
We therefore opt for a force kernel, which is more accurate, even though it requires four extra Fourier transforms.
In this case, we must solve the convolution in three dimensions and define the force kernel {\boldmath $\omega$}$_{F}$ such as:
\begin{eqnarray}
 {\bf F}({\bf x}) =  \int \rho({\bf x'}) \mbox{\boldmath $\omega$}_{F}({\bf x'} - {\bf x}) d{\bf x'}                                      
\label{eq:poisson_solution_force}
\end{eqnarray}
Because the gradient acting on \ref{eq:poisson_solution_pot} affects only un-prime variables, we can express the force kernel as a gradient of the potential kernel. Namely:  
\begin{eqnarray}
\mbox{\boldmath $\omega$}_{F}({\bf x}) \equiv - {\bf \nabla}\omega_{\phi}({\bf x}) = - \frac{mG \hat{\bf r}}{r^{2}}
\end{eqnarray}

Following the spherically symmetric matching technique of MPT (section 2.1), 
we split  the force kernel into two components, for the short and long range respectively, and 
match the overlapping region with a polynomial. Namely, we have:
\begin{eqnarray}
\mbox{\boldmath $\omega$}_{s}(r) = \begin{cases} \mbox{\boldmath $\omega$}_{F}(r) -  \mbox{\boldmath $\beta$}(r) &\mbox{if  } \mbox{$r$ $\le$ $r_{c}$ } \\
0 & \mbox{otherwise} 
\end{cases}
\end{eqnarray}
and
\begin{eqnarray}
\mbox{\boldmath $\omega$}_{l}(r) = \begin{cases} \mbox{\boldmath $\beta$}(r) &\mbox{if  } \mbox{$r$ $\le$ $r_{c}$ } \\
 \mbox{\boldmath $\omega$}_{F}(r)  &\mbox{otherwise} 
\end{cases}
\end{eqnarray}
The vector $\mbox{\boldmath $\beta$}(r)$ is related to the fourth order polynomial that is used in the potential case described in MPT by
 $ \mbox{\boldmath $\beta$} = - {\bf \nabla} \alpha(r)$. The coefficients are found by matching the boundary conditions at $r_{c}$ up to the second derivative,
 and we get
  \begin{eqnarray}
   \mbox{\boldmath $\beta$}(r) = \bigg[ -\frac{7 r}{4 r_{c}^{3}} + \frac{3 r^{3}}{4 r^{5}}\bigg] \hat{\bf r}
  \end{eqnarray}

Because these calculations are performed on two grids of different resolution, a sampling window function must be convoluted 
both with the density and the kernel (see [Eq. 7-8] of MPT).
When matching the two force kernels, the long range force is always on the low side close to the cutoff region, whereas the short range force is uniformly scattered across the theoretical $1/r^2$ value -- intrinsic features of the CIC and NGP interpolation schemes respectively.  By performing force measurements on two particles randomly placed in the volume, we identified a small region surrounding the cutoff length in which we empirically adjust both kernels such as to improve the match. Namely, for $14 \le r \le 16$, $\mbox{\boldmath $\omega$}_{s}({r}) \rightarrow 0.985\mbox{\boldmath $\omega$}_{s}({ r})$,
and for  $12 \le r \le 16$, $\mbox{\boldmath $\omega$}_{l}({r}) \rightarrow 1.2\mbox{\boldmath $\omega$}_{l}({ r})$.

As mentioned in section \ref{sec:structure} an summarized in FIg. \ref{fig:particle_mesh},
the force kernels are first  in the code initialization stage.
Eq. \ref{eq:poisson_solution_force} is then solved with fast Fourier transform along each directions, 
 and is applied onto particles in the {\tt update\_velocity} subroutine.

As an option, {\small PMFAST} could run with a different set of kernels, described in MPT as the `least square matching' , 
which basically adjust the kernels on cell-by-cell basis based on minimization of the deviation with respect
to the Newtonian predictions. This was originally computed such as to optimize the force calculation for
the case where both grids are obtained from CIC interpolation. Moving to a mix CIC/NGP scheme
requires solving the system of equations with the new configuration, a straightforward operation.
 With the inclusion of the random shifting, it is not clear how much improvement 
one would recover from this other kernel matching.  It is certainly something
we will investigate and document in the near future.


Finally, a choice must be done concerning the longest range of the coarse mesh force. Gravity can be either a) an accurate $1/r^2$ force, as far as the volume allows, 
or b) modified to correctly match the periodicity of the boundary conditions. By default, the code is configured along to the second choice,
which accurately models the growth of structures at very large scales. However, detailed studies of gravitational collapse of a single large object would benefit 
from the first settings, even though the code is not optimal for such settings.

