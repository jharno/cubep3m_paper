\section{Accuracy and Systematics}
\label{sec:accuracy}
 
 This section describes the systematics effects that are inherent to our P$^{3}$M algorithm.
 We start with a demonstration of the accuracy with a power spectrum measurement of a RANGER4000 simulation. 
 The halo mass function also assess the code capacity to model gravitational collapse, 
 but depends on the particular halo finder used.
 We thus post-pone the discussion on this aspect until in section \ref{sec:halo},
and focus for the moment on the particles only. In addition to the power spectrum, we further quantify the accuracy of the force calculation
 with comparisons to Newton's law of gravitation.
 
 
 \subsection{Density and Power Spectrum}
 \label{subsec:powerspectrum}
 
One of the most reliable way to assess the simulation's accuracy at evolving particles
is to measure the density power spectrum at late time, and compare to non-linear prediction. 
For an over-density field $\delta({\bf \it x})$, the power spectrum is extracted from the two point function in Fourier space as:
\begin{eqnarray}
\langle | \delta ({\bf \it k}) \delta ({\bf \it k'}) | \rangle = (2\pi)^{3}P(k)\delta_{D}({\bf \it k'} - {\bf \it k})
\label{eq:power}
\end{eqnarray}
where the angle bracket corresponds to an ensemble (or volume) average.
Fig. \ref{fig:density} presents  a 2-dimensional density projection of a RANGER4000 simulation, which evolved 4000$^3$ particles until redshift zero.
We then plot in Fig. \ref{fig:power_highres}  its dimensionless power spectrum  and
observe that the agreement with the non-linear prediction of \cite{Lewis:1999bs} is within five per cent up to $k = 1.0 h \mbox{Mpc}^{-1}$.
The drop of power at higher $k$ is partly caused by the finite mesh resolution, partly from expected deviations about the predictions.
The fluctuations at low-$k$ come from the white noise imposed in the initial conditions, and it was show in \citet{2012MNRAS.419.2949N} and 
\citet{2012MNRAS.423.2288H} that
samples of a few hundreds of realizations average to the correct value. 

\begin{figure*}%[ht]
  \begin{center}
%    \includegraphics[width=5.2in]{graphs/0.000xz_w_halos_pink_blue_enh-1.eps}
\includegraphics[width=5.2in]{graphs/0.000proj_1000x1000.eps}
  \caption{Detail of a dark matter density projection, measured at $z=0$ in a RANGER4000 simulation.
  Particles are shown in pink, halos in blue in the online version. The full projection is 64 times larger,
  but does not provide much details on the structure on a paper format.
    \label{fig:density}}
\end{center}
\end{figure*}


\begin{figure*}%[ht]
  \begin{center}
    \includegraphics[width=5.2in]{graphs/power_highres.eps}
  \caption{Dark matter power spectrum, measured at $z=0$ in a RANGER4000 simulation,
  compared to the non-linear predictions of {\small CAMB}. 
  The vertical line corresponds to the scale of the coarse mesh, while the dotted line represents the Poisson noise.
    \label{fig:power_highres}}
\end{center}
\end{figure*}

\subsection{Mesh force at grid distances}
\label{subsec:force}

The force test presented in MPT was carried by placing two particles at random locations on the grid, calculate the force between them, then iterate
over different locations. This pairwise force test is useful to quantify the accuracy on a cell-by-cell basis, but lacks the statistics that occur in an actual time step calculation.  
The actual force of gravity in the P$^3$M algorithm,
as felt by a single particle during a single step, is presented in the top left panel of Fig. \ref{fig:den_force_fracErr}.
This force versus distance plot was obtained from a CITA128 realization, and the calculation proceeds in two steps: 
1- we compute the force on each particle in a given time step.
2- we remove a selected particle, thus creating a `hole', compute the force again on all particles, and record on file the 
force difference (before  and after the removal) as a function of the distance to the hole.

Particles in the same fine cell as the hole follow the exact $1/r^{2}$ curve. The scatter at 
  distances of the order of the fine grid is caused by the NGP interpolation scheme:
  particles in adjacent fine cells can be actually very close, as seen in the upper left region of this plot,
  but still feel the same mesh force at grid cell distances.
This  creates a discrepancy up to an order of magnitude, in loss or gain, depending on the location of the pair with respect to the centre of the cell.
As the separation approaches a tenth of the full box size or so, the force on the coarse mesh 
scatters significantly about Newton's law due to periodic boundary conditions. 
As mentioned at the end of section \ref{sec:Poisson}, the longest range of force kernel can either model accurately Newtonian gravity,
or the structure growth of the largest modes, but not both. For the sake of demonstrating the accuracy of the force calculation,
we chose the first option in this section.

It is not clear from these scatter plots whether the mean force felt  is below or under the predictions, hence we rebin the results
in 50 logarithmically spaced bins and compute the mean and standard deviation. 
We show this plot in the middle left panel of Fig. \ref{fig:den_force_fracErr}, where we observe that on average,
there is a loss of force of the order of unity in the range $ 0.4 < r < 1$ (in units of fine grid), but the force force is otherwise
in excellent agreement with Newton's law.


The top right and middle right panels of Fig. \ref{fig:den_force_fracErr} show the fractional error on the force along the radial and tangential directions, also calculated from a single time step.
The mean of the radial component is up to 80 per cent away from the exact law at sub-grid distances, but quickly drops under ten per cent for larger distances. 
The transverse fractional error peaks exactly at the gris distance,  and is about two time smaller than the radial counterpart.

\begin{figure*}%[ht]
  \begin{center}
    \includegraphics[width=3.2in]{graphs/densityForce_ppext=0_new-1.eps}
    \includegraphics[width=3.2in]{graphs/densityForce_fracErr_ppext=0_new-1.eps}
    \includegraphics[width=3.2in]{graphs/densityForce_ppext=0_rebin_new-1.eps}
    \includegraphics[width=3.2in]{graphs/densityForce_fracErr_ppext=0_rebin_new-1.eps}
    \includegraphics[width=3.2in]{graphs/densityForce_ppext=0_rebin_N10_new-1.eps}
    \includegraphics[width=3.2in]{graphs/densityForce_fracErr_ppext=0_rebin_N10_new-1.eps}
  \caption{({\it top left}:) Gravity force in of the P$^3$M algorithm, versus distance in fine mesh cell units, compared with the exact $1/r^{2}$ law.
    This particular calculation was obtained in a CITA128 realization with  a box size of $100 h^{-1}\mbox{Mpc}$,
    in a single time step. 
    ({\it top right}:) Fractional error on the force in of the P$^3$M algorithm, in the radial (top) and tangential (bottom) directions.
  In a full simulation run, the scatter averages over many time steps, 
    thanks to the inclusion of a random offset that is imposed on each particle, as discussed in the main text.
    ({\it middle row}:) Top row organized in 50 logarithmic bins.  
    ({\it bottom row}:) Same as middle row, but averaged over ten time steps.
    \label{fig:den_force_fracErr}}
\end{center}
\end{figure*}

At grid scales, the fractional error is larger than {\small PMFAST}, largely due to the fact that the fine mesh force is performed with an NGP interpolation scheme -- as opposed to CIC. This prescription is responsible for the larger scatter about the theoretical value, but, as mentioned earlier, 
NGP interpolation is essential to our implementation of the pp part.
At the same time, the biggest problem with the straightforward pp force calculation is that the results 
are anisotropic and depend on the location of the fine mesh with respect 
to the particles. As an example, consider two particles on either side of a grid 
cell boundary, experiencing their mutual gravity attraction via the fine mesh force with a discretized one-grid cell separation.
 If, instead, the mesh was shifted such that they were
within the same cell, they would experience the much larger pp force. 
This is clearly seen in the top left panel of Fig. \ref{fig:den_force_fracErr}, where particles physically close, but in different grid cells, 
feel a force up to an order of magnitude too small.
This effect is especially pronounced at the early stages of the simulation where
the density is more homogeneous, and leads to mesh artefacts appearing
in the density field.

In order to minimize these two systematic effect -- the large scatter and the anisotropy -- 
we randomly shift the particle distribution relative to the mesh by a small
amount -- up to 2 fine grid cells in magnitude -- in each
dimension and at each time step.  This adds negligible computational
overhead as it is applied during the particle position update,
and suppresses the mesh behaviour that otherwise grows over multiple time steps.
It is possible to shift back the particles at the end of each time steps,
which prevents a random drift of the whole population, a necessary step 
if one needs to correlate the initial and final positions of the particles for instance,
or for hybrid dark matter -- MHD simulations.
 
We ensure that, on average, this solution balances out the mesh feature,
by tuning the force kernels such as to provide a force as evenly balanced as possible, both at grid cell distances
and at the cutoff length ($r_{c}=16$ fine cells).
These adjustments are performed from the pairwise force test mentioned above (and described in MPT).
The bottom panels of Fig. \ref{fig:den_force_fracErr} show the effect of averaging over ten time steps, 
where the random offset is applied on the particles (and on the hole) at the end of each force calculation. 
We observe that the agreement extends at the per cent level down to $r \sim 1.5$, beyond which point
the discretize effect of the NGP causes an underestimate of the force of up to 60 per cent.
%{\bf (Can't we beat this by tempering with the fine force kernel? Will the least square fit enhance this?)}

We note that this inevitable loss of force in the NGP scheme is one of the driving argument to extend the pp force outside the fine mesh cell,
since the scattering about the actual $1/r^{2}$ law drops rapidly as the distance increases.
As discussed in section \ref{subsec:extendedpp}, this gain in accuracy comes at a computational price,
but at least we have the option to run the code with high precision.

We present in Fig. \ref{fig:disp_mesh} the dramatic impact of removing the random offset in the otherwise default code configuration.
This test was performed with a CITA256 simulation of very large box size,
the output redshifts are very early (the upper most curve ($z=10$) was obtained after
about 60 time steps), such that the power spectrum should agree with linear theory up to the resolution limit.
Instead, we observe that the power spectrum grows completely wrong, due to the large scatter in the force from the fine mesh,
and to the anisotropic nature of the P$^3$M calculations mentioned above.
When these effects are not averaged over, the errors directly add up at each time step,
which explains why later time are worst.
We recall that {\small PMFAST} did not have this problem since it used CIC interpolation on both meshes.  
%{\bf (Anything else to add here?)}

\begin{figure}%[ht]
  \begin{center}
    \includegraphics[width=3.2in]{graphs/power_w_wo_disp_mesh.eps}
  \caption{Dark matter power spectrum, measured at $z=180$, $100$, $20$ and $10$, in a CITA256 realization that is 1000 Mpc/$h$ per side. The dashed line represent the initial condition power spectrum, the dotted lines are the linear predictions, and  the open circles the standard P$^3$M configuration. 
  The dots were obtained by simply removing the random offset that is normally applied at each time step. \label{fig:disp_mesh}}
\end{center}
\end{figure}

%\begin{figure*}%[ht]
 % \begin{center}
  %   \includegraphics[width=3.2in]{graphs/densityForce_Zoom_N1.eps}
   % \includegraphics[width=3.2in]{graphs/densityForce_Zoom_N10.eps}
  % \includegraphics[width=3.2in]{graphs/densityForce_fracErr_N1.eps}
  %  \includegraphics[width=3.2in]{graphs/densityForce_fracErr_N10.eps}
 % \caption{({\it top}:) Gravity force in of the P$^3$M algorithm, versus distance in fine mesh cell units, compared with the exact $1/r^{2}$ law.
 %   This particular calculation was obtained in a CITA128 realization with  a box size of $100 h^{-1}\mbox{Mpc}$.
  %  ({\it bottom}:) Fractional error on the force in of the P$^3$M algorithm, in the radial (top) and tangential (bottom) directions.
   % The left panels are calculated from a single time step, while the right panels show the average over time time steps.
 %   \label{fig:den_force_N10}}
%\end{center}
%\end{figure*}

%\begin{figure}%[ht]
 % \begin{center}
  %   \includegraphics[width=3.2in]{graphs/densityForce_ppext=10_rebin.eps}
  %\caption{ Gravity force in of the P$^3$M algorithm, versus distance in fine mesh cell units, compared with the exact $1/r^{2}$ law.
   % This particular calculation was obtained in a CITA128 realization with  a box size of $100 h^{-1}\mbox{Mpc}$, averaged over 10 time steps.
   % Results are rebined to show how well the mean value follows the thoretical curve down to the grid size.
   % \label{fig:F_rebin}}
%\end{center}
%\end{figure}

\subsection{Constraining redshift jumps}
\label{subsec:z_jumps}


At early stages of the simulation, the density fields is rather homogenous, causing the force of gravity to be
rather weak everywhere. In that case, the size of the redshift jumps is controlled by a limit in the cosmological expansion.
If the expansion jump is too large, the size of the residual errors can become significant, and one can observe, for instance,
a growth of structure that does not match the predictions of  linear theory even at the largest scales.
One therefore needs to choose a maximum step size. In {\small CUBEP3M}, this is controlled by $r_{max}$, which is the fractional step size,
$\mbox{d}a/(a + \mbox{d}a)$ and is set to $0.05$ by default.  Generally, a simulation should start at a redshift high enough that
the initial dimensionless power spectrum is well under unity at all scales. This ensures that the Zel'dovich approximation
 holds at the per cent level at least. A drop of accuracy can occur if one starts the simulation too early, where
 truncation error will be significant at the early time steps.


It is possible to reduce this effect, and thereby improve significantly 
the accuracy of the code, by modifying the value of $r_{max}$, at the cost of increasing the total number of time steps.
Fig. \ref{fig:ra_max} shows a comparison of late time power spectra of a series of CITA256 realizations that originate from the same initial conditions, 
and used the same random seeds to control the fine mesh shifts (mentioned above): only the value of $r_{max}$ was modified between each run. 
We observe that the impact is mostly located in the non-linear regime, where decreasing the time step to 0.006 
allows the simulation to recover about 30 per cent of dimensionless power at the turn over scale, in this simulation configuration.
This gain is greatly affected by the choice of initial redshift, the resolution, and the box size, and ideally one would make
test runs in order to optimize a given configuration.  
As expected, the {\small CPU} resources required to run these simulations increase rapidly as $r_{max}$ decreases, as seen in Table \ref{table:ra_max}. 
In this test case, reducing further at 0.001 shows only a mild improvement in accuracy, but the increase in time is more than a factor of four.
We should mention that with a proper use of the non-Gaussian initial conditions, it is possible to start the simulations at much later redshifts, where the time step sizes are dominated by a stronger mesh force.
 

\begin{figure}%[ht]
  \begin{center}
    \includegraphics[width=3.2in]{graphs/power_ra_max.eps}
  \caption{Dark matter power spectrum, measured at $z=0$ in a series of CITA256 realizations. 
 The starting redshift was raised to $z=200$ to enhance the systematic effect. The different curves show different values of $r_{max}$. 
  The resources required to run these simulations increase rapidly as $r_{max}$ decreases, as seen in Table \ref{table:ra_max}.    \label{fig:ra_max}}
\end{center}
\end{figure}

\begin{table}
\begin{center}
\caption{Scaling in {\small CPU} resources as a function of the value of $r_{max}$. The tests were performed 
on the CITA Sunnyvale cluster, and general trends could vary slightly on other machines.}
\begin{tabular}{|l|c|c|}
\hline 
$r_{max}$         & time (h)   \\                 
\hline
 $0.1$ & 1.46 \\
 $0.06$ & 1.48\\
 $0.01$ & 1.67 \\
 $0.006$ & 1.91\\
 $0.003$ & 2.83 \\
 $0.002$ & 4.13\\
 $0.001$ & 8.15\\
\hline
\end{tabular}
\label{table:ra_max}
\end{center}
\end{table}


%{\bf (Any other systematics effects we want to discuss here?)}

 


